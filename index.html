<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新年烟花</title>
    <style>
        /* ... [之前的样式代码保持不变] ... */
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <button id="settingsButton">自定义文字</button>
    <div id="settingsPanel">
        <input type="text" id="textInput" placeholder="请输入烟花文字" maxlength="20" value="2025新年快乐">
        <button id="applyButton">确定</button>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let customText = "2025新年快乐";
        let audioEnabled = true;

        // 设置canvas尺寸
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // 音效（使用较短的音频文件）
        const audio = {
            explosion: new Audio('https://fireworks.js.org/sounds/explosion.mp3'),
            launch: new Audio('https://fireworks.js.org/sounds/launch.mp3')
        };

        const audioPool = {
            explosion: Array.from({ length: 5 }, () => new Audio('https://fireworks.js.org/sounds/explosion.mp3')),
            launch: Array.from({ length: 5 }, () => new Audio('https://fireworks.js.org/sounds/launch.mp3')),
            currentIndex: 0
        };

        function playSound(type) {
            if (!audioEnabled) return;
            const sound = audioPool[type][audioPool.currentIndex];
            sound.currentTime = 0;
            sound.volume = type === 'explosion' ? 0.3 : 0.2;
            sound.play().catch(() => {});
            audioPool.currentIndex = (audioPool.currentIndex + 1) % audioPool[type].length;
        }

        // ... [Firework 和 Particle 类的代码保持不变] ...

        const fireworks = [];
        let lastAutoLaunch = 0;
        const AUTO_LAUNCH_INTERVAL = 2000; // 缩短间隔到2秒

        function autoLaunchFirework() {
            const now = Date.now();
            if (now - lastAutoLaunch > AUTO_LAUNCH_INTERVAL) {
                const startX = Math.random() * canvas.width;
                const targetX = canvas.width / 2 + (Math.random() - 0.5) * 200; // 增加随机性
                const targetY = canvas.height * 0.3;
                
                fireworks.push(new Firework(
                    startX,
                    canvas.height,
                    targetX,
                    targetY,
                    Math.random() < 0.5 // 50%概率显示文字
                ));
                
                lastAutoLaunch = now;
            }
        }

        // 动画循环
        function animate() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            autoLaunchFirework(); // 自动发射烟花

            for (let i = fireworks.length - 1; i >= 0; i--) {
                const firework = fireworks[i];
                if (!firework.update()) {
                    fireworks.splice(i, 1);
                } else {
                    firework.draw();
                }
            }

            requestAnimationFrame(animate);
        }

        // 设置面板控制
        const settingsButton = document.getElementById('settingsButton');
        const settingsPanel = document.getElementById('settingsPanel');
        const textInput = document.getElementById('textInput');
        const applyButton = document.getElementById('applyButton');

        settingsButton.addEventListener('click', (e) => {
            e.stopPropagation();
            settingsPanel.style.display = settingsPanel.style.display === 'none' ? 'block' : 'none';
        });

        applyButton.addEventListener('click', () => {
            customText = textInput.value || "2025新年快乐";
            settingsPanel.style.display = 'none';
        });

        // 点击事件
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            fireworks.push(new Firework(
                Math.random() * canvas.width,
                canvas.height,
                x,
                y,
                Math.random() < 0.5
            ));
        });

        // 触摸事件
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            fireworks.push(new Firework(
                Math.random() * canvas.width,
                canvas.height,
                x,
                y,
                Math.random() < 0.5
            ));
        });

        // 点击其他地方关闭设置面板
        document.addEventListener('click', (e) => {
            if (!settingsPanel.contains(e.target) && e.target !== settingsButton) {
                settingsPanel.style.display = 'none';
            }
        });

        // 立即开始动画
        animate();

        // 尝试启用音频
        window.addEventListener('click', () => {
            audioEnabled = true;
            audio.launch.volume = 0;
            audio.launch.play().catch(() => {});
        }, { once: true });
    </script>
</body>
</html>
